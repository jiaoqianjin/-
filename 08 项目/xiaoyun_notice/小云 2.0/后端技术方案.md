# 小云通知2.0 Java技术文档

## 一、修订记录

| 修订日期   | 修订后版本 | 修订说明 | 修订人         |
| ---------- | ---------- | -------- | -------------- |
| 2020-12-11 | 1.0        | 初版     | @焦前进@张仁杰 |
|            |            |          |                |



---

## 二、背景和目标

### 背景：

#### 1. 产品背景：

- 客户端分组管理依赖于管理端，不便于用户对分组的管理；
- 联系人公共分组没有分级显示，不能很好的展示联系人架构；
- 通知反馈统计没有按分组展示，多用户多分组场景不适用；

#### 2. 技术背景：

- 客户端api接口为**java**实现，未使用框架，技术存在漏洞和不合理的地方；
- 客户端和管理端分别为**Java**实现和**php**实现，不利于后期的维护；
- 控制层存在大量的业务代码，结构混乱，日志，异常等不符合现在的开发规范；
- 未使用redis,一些需要缓存的数据存在map里，一些不经常变动的数据未进行持久化。

### 目标

1. 客户端和管理端统一使用Java语言实现。整合php和java接口；
2. 采用spme-admin 后端通用开发框架；
3. 尽量减少原有功能的接口改动；
4. 优化联系人公共分组，返回给前端树形结构数据；



---

## 三、架构设计和技术细节

### 1. 系统流程图

[系统流程图](https://www.processon.com/diagraming/5fd16c0907912906da48e764)

![小云通知2.0 系统流程图](https://gitee.com/jiao_qianjin/zhishiku/raw/master/img/20201211170800.jpg)

### 2. 系统架构图

[系统架构图](https://www.processon.com/diagraming/5fd03bf57d9c0830e8e4e653)

![小云通知2.0 系统架构图](https://gitee.com/jiao_qianjin/zhishiku/raw/master/img/20201211163013.jpg)

### 3. smpe-admin 后端通用框架

[后端源码](https://github.com/shiwei-Ren/smpe-admin)

基于[EL-ADMIN](https://el-admin.vip/)、Spring Boot 2.1.0、JDK1.8+ 、 Mybatis Plus、JWT + Spring Security、Redis ...

#### 项目结构

```java
- smpe-common 公共模块
    - annotation 为系统自定义注解
    - aspect 自定义注解的切面
    - base 提供了常用基类
    - bean 读取yml中的通用配置类
    - config 全局配置文件，例如swagger、mybatisplus、redis、跨域处理等的配置
        - thread 线程池相关
    - enums 全局枚举类
    - exception 项目统一异常的处理
    - response 统一返回前端数据封装
    - utils 系统通用工具类
- smpe-system 系统核心模块（系统启动入口）
    - config 核心模块配置（非全局配置）
    - modules 系统相关模块(登录授权、用户部门管理等、自定义业务)
        - business 业务模块（一般项目业务开发模块可放在此包下，各模块可构建自己的config、utils、enums等）
        - generator mpbatisplus的代码生成（后端）
        - security 安全认证（SpringSecurity+JWT）
        - system 系统核心模块（用户、角色、部门、岗位、菜单管理等）
        - upload 文件模块（上传、下载等）
    - utils 核心模块工具类
- smpe-xxx （自定义待开发模块）
- sql 数据库文件
- Dockerfile 构建后端服务器环境的Dockerfile（基于docker）
- smpe-admin.sh 后端部署脚本
- smpe-admin.conf nginx配置文件
```

#### 使用技术参考文档

- 后端持久层框架使用MybatisPlus，参考：[MybatisPlus官方文档](https://hutool.cn/docs/#/)

- Java轻量级开发工具包HuTool，参考：[HuTool官方文档](https://hutool.cn/docs/#/)。*暂时不使用 hutool-json*

- lombok，参考：[Lombok features](https://projectlombok.org/features/all?hmsr=aladdin1e5)

- Java 实体映射工具——MapStruct，参考：[SpringBoot使用MapStruct自动映射DTO](https://www.jianshu.com/p/3f20ca1a93b0)

- FastJson（阿里巴巴），参考[Fastjson 简明教程](https://www.runoob.com/w3cnote/fastjson-intro.html)

#### 开发流程

- 数据库新建表之后，使用MybatisPlusGenerator在business下生成相应文件。
- 之后接口开发和往常相同，接口需要权限则加上@PreAuthorize("@smpe.check('xxx')")；
- 该框架默认所有接口访问都需要token，不需要token的需要在接口上加@AnonymousAccess；

#### 接口相应数据

##### 1. 不分页响应数据结构

```java
[
    "code":"",
    "message":"",
    "data":[
            {"id": 1, "name": "Tom"}
        ]
]
```

##### 2. 分页响应数据结构

```java
[
    "code":"",
    "message":"",
    "data":[
        // 返回查询数据
        "records": [
            {"id": 1, "name": "Tom"}
        ]
        "total": 2,		// 返回总记录数
        "size": 10,      // 每页条数
        "current": 1,    // 返回当前页码
        "orders": [
          {
            "column": "create_time",
            "asc": false
          }
        ],
        "optimizeCountSql": true, 	//sql优化，OptimizeCountSql默认为true，优化，不执行select count(1)操作
        "hitCount": false,
        "countId": null,
        "maxLimit": null,
        "searchCount": true,
        "pages": 1 	// 返回总页数
    ]
]
```



## 四、开发规范

[java编码规范](http://gitlab.marchsoft.cn/sangjinchao/doc_standard/-/blob/master/java.pdf)

[后端开发规范](http://gitlab.marchsoft.cn/sangjinchao/doc_standard/-/blob/master/%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E8%A7%84%E8%8C%83V0.3.md) 待更新...

---

## 五、服务器部署

docker安装nginx: [docker安装nginx](https://blog.csdn.net/qq_42937522/article/details/108179441)
docker构建后端环境: [docker构建后端环境](https://blog.csdn.net/qq_42937522/article/details/107755941)



